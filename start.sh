#!/bin/bash
# Ğ¡ĞºÑ€Ğ¸Ğ¿Ñ‚ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ° Ğ±Ğ¾Ñ‚Ğ° Ğ´Ğ»Ñ Linux
# Ğ—Ğ°Ğ¿ÑƒÑĞº: ./start.sh

echo "ğŸš€ Ğ—Ğ°Ğ¿ÑƒÑĞº Telegram Ğ±Ğ¾Ñ‚Ğ°..."

# Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ´Ğ»Ñ Ñ†Ğ²ĞµÑ‚Ğ½Ğ¾Ğ³Ğ¾ Ğ²Ñ‹Ğ²Ğ¾Ğ´Ğ°
print_color() {
    local color=$1
    local message=$2
    case $color in
        "green") echo -e "\033[32m$message\033[0m" ;;
        "red") echo -e "\033[31m$message\033[0m" ;;
        "yellow") echo -e "\033[33m$message\033[0m" ;;
        "blue") echo -e "\033[34m$message\033[0m" ;;
        "cyan") echo -e "\033[36m$message\033[0m" ;;
        *) echo "$message" ;;
    esac
}

# ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ½Ğ°Ğ»Ğ¸Ñ‡Ğ¸Ğµ Deno
if ! command -v deno &> /dev/null; then
    print_color "yellow" "âŒ Deno Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½. Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼..."
    curl -fsSL https://deno.land/x/install/install.sh | sh
    export PATH="$HOME/.deno/bin:$PATH"
    print_color "green" "âœ… Deno ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½!"
fi

# ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ½Ğ°Ğ»Ğ¸Ñ‡Ğ¸Ğµ Ñ„Ğ°Ğ¹Ğ»Ğ° .env
if [ ! -f ".env" ]; then
    print_color "yellow" "âŒ Ğ¤Ğ°Ğ¹Ğ» .env Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½. Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‘Ğ¼ Ğ¸Ğ· Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€Ğ°..."
    if [ -f "env.example" ]; then
        cp env.example .env
        print_color "yellow" "âš ï¸  ĞÑ‚Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€ÑƒĞ¹Ñ‚Ğµ Ñ„Ğ°Ğ¹Ğ» .env Ñ Ğ²Ğ°ÑˆĞ¸Ğ¼Ğ¸ API ĞºĞ»ÑÑ‡Ğ°Ğ¼Ğ¸!"
        nano .env
        read -p "ĞĞ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ Enter Ğ¿Ğ¾ÑĞ»Ğµ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ .env Ñ„Ğ°Ğ¹Ğ»Ğ°"
    else
        print_color "red" "âŒ Ğ¤Ğ°Ğ¹Ğ» env.example Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½!"
        exit 1
    fi
fi

# ĞÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ğµ Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑÑ‹
print_color "yellow" "ğŸ”„ ĞÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ğµ Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑÑ‹..."
pkill -f "deno.*chatbot.ts" 2>/dev/null || true

# Ğ–Ğ´Ñ‘Ğ¼ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¸Ñ Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑĞ¾Ğ²
sleep 2

# Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ğ±Ğ¾Ñ‚Ğ° Ğ² Ñ„Ğ¾Ğ½Ğµ
print_color "green" "ğŸ¤– Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ğ±Ğ¾Ñ‚Ğ°..."
nohup deno run --allow-read --allow-write --allow-env --allow-net chatbot.ts > bot.log 2>&1 &

# Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ PID
echo $! > bot.pid

print_color "green" "âœ… Ğ‘Ğ¾Ñ‚ Ğ·Ğ°Ğ¿ÑƒÑ‰ĞµĞ½ Ğ² Ñ„Ğ¾Ğ½Ğµ! PID: $(cat bot.pid)"
print_color "blue" "ğŸ“ Ğ›Ğ¾Ğ³Ğ¸: tail -f bot.log"